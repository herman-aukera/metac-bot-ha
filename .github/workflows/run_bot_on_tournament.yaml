name: Forecast on new AI tournament questions

on:
  workflow_dispatch:
    inputs:
      scheduling_frequency_hours:
        description: 'Override scheduling frequency in hours'
        required: false
        default: '4'
        type: string
      tournament_mode:
        description: 'Tournament operation mode'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - critical
          - final_24h
      tournament_id:
        description: 'Metaculus tournament ID to target (overrides default)'
        required: false
        type: string
      tournament_slug:
        description: 'Metaculus tournament slug (e.g., fall-aib-2025)'
        required: false
        type: string
  schedule:
    - cron: '0 */5 * * *' # Every 5 hours for sustainable tournament operation

concurrency:
  group: tournament-forecasting
  cancel-in-progress: true

jobs:
  tournament_forecast:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Prevent hanging workflows
    strategy:
      fail-fast: false # Continue even if one attempt fails
    env:
      # Make required secrets available to all steps
      METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      # Optional (used if present)
      ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID }}
      ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 🔧 Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: 📦 Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: 🔧 Install dependencies with robust fallback
        id: install-deps
        run: |
          set -e

          echo "🔍 Checking Python environment..."
          python --version
          pip --version

          echo "📦 Attempting Poetry dependencies installation..."
          # Try Poetry first but immediately fall back to pip if ANY issues
          if poetry install --only main 2>/dev/null && poetry run python --version >/dev/null 2>&1; then
            echo "✅ Poetry installation successful"
            POETRY_SUCCESS=true
          else
            echo "⚠️ Poetry installation failed or environment broken, falling back to pip immediately..."
            POETRY_SUCCESS=false
          fi

          # Immediate pip fallback with essential packages
          if [ "$POETRY_SUCCESS" = "false" ]; then
            echo "🔄 Installing essential packages via pip..."
            pip install --upgrade pip

            # Install critical packages that are needed for the bot
            pip install python-dotenv pydantic requests openai anthropic httpx aiofiles pyyaml typer pytest

            # Install forecasting_tools (critical for tournament bot)
            pip install forecasting-tools || echo "⚠️ forecasting-tools not available via pip"

            # Try installing as editable package if possible
            pip install -e . 2>/dev/null || echo "⚠️ Local package install failed"
          fi

          # Verify critical packages are available
          echo "🧪 Verifying critical dependencies..."
          python -c "
          import sys
          critical_packages = ['dotenv', 'pydantic', 'requests', 'openai']
          missing = []
          for pkg in critical_packages:
              try:
                  __import__(pkg)
                  print(f'✅ {pkg}: available')
              except ImportError:
                  missing.append(pkg)
                  print(f'❌ {pkg}: missing')

          if missing:
              print(f'⚠️ Installing missing critical packages: {missing}')
              import subprocess
              for pkg in missing:
                  try:
                      subprocess.check_call([sys.executable, '-m', 'pip', 'install', pkg])
                      print(f'✅ Emergency install of {pkg} successful')
                  except:
                      print(f'❌ Emergency install of {pkg} failed')
          "

      - name: 🧪 Debug Python environment
        run: |
          echo "🔍 Python Environment Debug:"
          python --version
          python -c "import sys; print('Python executable:', sys.executable)"
          python -c "import sys; print('Python path:', sys.path)"
          echo "📦 Installed packages:"
          pip list | head -20

          echo "🧪 Testing critical imports:"
          python -c "
          import sys
          try:
              import dotenv
              print('✅ dotenv imported successfully')
          except ImportError as e:
              print(f'❌ Failed to import dotenv: {e}')
              sys.exit(1)
          "

      - name: 🎯 Run tournament forecasting bot
        id: run-bot
        env:
          # Tournament targeting (GitHub Variables)
          TOURNAMENT_ID: ${{ vars.AIB_TOURNAMENT_ID || '' }}
          TOURNAMENT_SLUG: ${{ vars.AIB_TOURNAMENT_SLUG || inputs.tournament_slug || '' }}
          # Optional config overrides
          SCHEDULING_FREQUENCY_HOURS: ${{ inputs.scheduling_frequency_hours || '4' }}
          TOURNAMENT_MODE: ${{ inputs.tournament_mode || 'normal' }}
          # Production settings
          DRY_RUN: false
          DISABLE_PUBLICATION_GUARD: true
          # TEMPORARY: Set to false for ONE-TIME re-forecast of fallback questions
          # RESTORE to true after successful run to avoid duplicate forecasts
          SKIP_PREVIOUSLY_FORECASTED: false
        run: |
          set -e

          # Robust Python runner detection with dependency verification
          echo "🔍 Determining Python execution method..."
          if poetry env info >/dev/null 2>&1 && poetry run python --version >/dev/null 2>&1 && poetry run python -c "import pydantic, requests" 2>/dev/null; then
            echo "🚀 Poetry environment verified and working - using Poetry runner"
            PY_RUN="poetry run python"
          else
            echo "🐍 Poetry environment not available or broken - using system Python"
            PY_RUN="python"
            export PYTHONPATH="${PWD}/src:${PYTHONPATH:-}"

            # Emergency dependency check for system Python
            echo "🧪 Verifying system Python has critical dependencies..."
            python -c "
            import sys
            missing_critical = []
            for pkg in ['dotenv', 'pydantic', 'requests']:
                try:
                    __import__(pkg)
                except ImportError:
                    missing_critical.append(pkg)

            if missing_critical:
                print(f'❌ Critical packages missing: {missing_critical}')
                print('⚡ Installing emergency dependencies...')
                import subprocess
                subprocess.check_call([sys.executable, '-m', 'pip', 'install'] + missing_critical)
                print('✅ Emergency dependencies installed')
            else:
                print('✅ All critical dependencies available')
            " || echo "⚠️ Emergency dependency installation attempted"
          fi

          echo "🎯 Starting tournament bot execution..."
          if $PY_RUN main.py; then
            echo "✅ Bot execution completed successfully"
            echo "success=true" >> "$GITHUB_OUTPUT"
          else
            echo "❌ Bot execution failed"
            echo "success=false" >> "$GITHUB_OUTPUT"

            # Create fallback summary for failed executions
            cat > run_summary.json << EOF
          {
            "status": "failed",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "error": "Bot execution failed during tournament forecasting",
            "workflow_run": "${{ github.run_id }}",
            "commit": "${{ github.sha }}"
          }
          EOF

            exit 1
          fi

      - name: 📊 Upload execution summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tournament-run-summary-${{ github.run_id }}
          path: run_summary.json
          retention-days: 30

      - name: 📁 Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tournament-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
