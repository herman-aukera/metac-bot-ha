name: Forecast on new AI tournament questions

on:
  workflow_dispatch:
    inputs:
      scheduling_frequency_hours:
        description: 'Override scheduling frequency in hours'
        required: false
        default: '4'
        type: string
      tournament_mode:
        description: 'Tournament operation mode'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - critical
          - final_24h
  # Optimized tournament scheduling - runs every 4 hours for sustainable operation
  # Configurable scheduling based on tournament phase and budget constraints
  # For deadline-aware scheduling, use the tournament_deadline_aware.yaml workflow
  schedule:
    - cron: '0 */4 * * *' # Every 4 hours for sustainable tournament operation

# Optimized concurrency control for tournament scheduling
concurrency:
  group: tournament-forecasting
  cancel-in-progress: true # Cancel previous runs to avoid queue buildup

# Job to run the tournament forecast bot
jobs:
  tournament_forecast:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Prevent hanging workflows
    strategy:
      fail-fast: false # Continue even if one attempt fails
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Update poetry lock file
        run: poetry lock --no-update

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Validate API keys
        run: |
          poetry run python -c "
          from src.infrastructure.config.api_keys import api_key_manager
          import sys
          validation = api_key_manager.validate_required_keys()
          api_key_manager.log_key_status()
          if not validation['valid']:
              print('‚ùå Missing required API keys:', [k['key'] for k in validation['missing_keys']])
              sys.exit(1)
          else:
              print('‚úÖ All required API keys are configured')
          "
        env:
          METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY || 'dummy_perplexity_key' }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY || 'dummy_exa_key' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'dummy_openai_key' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || 'dummy_anthropic_key' }}
          ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID || 'dummy_asknews_client' }}
          ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET || 'dummy_asknews_secret' }}

      - name: Display scheduling configuration
        run: |
          echo "üìÖ Tournament Scheduling Configuration:"
          echo "  Frequency: ${{ github.event.inputs.scheduling_frequency_hours || vars.SCHEDULING_FREQUENCY_HOURS || '4' }} hours"
          echo "  Mode: ${{ github.event.inputs.tournament_mode || 'normal' }}"
          echo "  Deadline-aware: ${{ vars.DEADLINE_AWARE_SCHEDULING || 'true' }}"
          echo "  Critical period frequency: ${{ vars.CRITICAL_PERIOD_FREQUENCY_HOURS || '2' }} hours"
          echo "  Final 24h frequency: ${{ vars.FINAL_24H_FREQUENCY_HOURS || '1' }} hours"
          echo "  Tournament scope: ${{ vars.TOURNAMENT_SCOPE || 'seasonal' }}"

      - name: Check budget status before run
        id: budget_check
        run: |
          echo "üí∞ Checking budget status before forecasting run..."
          poetry run python -c "
          from src.infrastructure.config.budget_manager import BudgetManager
          from src.infrastructure.monitoring.budget_dashboard import BudgetDashboard
          import sys
          import os

          budget_manager = BudgetManager(budget_limit=float(os.getenv('BUDGET_LIMIT', '100')))
          dashboard = BudgetDashboard(budget_manager)

          status = budget_manager.get_budget_status()
          print(f'üí∞ Budget Status: {status[\"status\"]}')
          print(f'üí∏ Spent: \${status[\"spent\"]:.2f} / \${status[\"budget_limit\"]:.2f}')
          print(f'üìä Utilization: {status[\"utilization\"]:.1%}')

          # Set output for workflow decisions
          print(f'budget_status={status[\"status\"]}', file=open(os.environ['GITHUB_OUTPUT'], 'a'))
          print(f'budget_utilization={status[\"utilization\"]:.3f}', file=open(os.environ['GITHUB_OUTPUT'], 'a'))
          print(f'budget_remaining={status[\"remaining\"]:.2f}', file=open(os.environ['GITHUB_OUTPUT'], 'a'))

          # Check if we should continue
          if status['utilization'] >= 0.98:
              print('üö® CRITICAL: Budget exhausted (98%+), suspending workflow')
              sys.exit(1)
          elif status['utilization'] >= 0.95:
              print('‚ö†Ô∏è WARNING: Budget critical (95%+), emergency mode activated')
          elif status['utilization'] >= 0.80:
              print('‚ö†Ô∏è CAUTION: Budget high (80%+), conservative mode activated')
          else:
              print('‚úÖ Budget status normal, proceeding with forecasting')
          "
        env:
          BUDGET_LIMIT: ${{ vars.BUDGET_LIMIT || '100' }}

      - name: Run bot with monitoring
        if: steps.budget_check.outputs.budget_utilization < '0.98'
        run: |
          echo "üöÄ Starting tournament forecasting bot..."
          echo "üí∞ Budget utilization: ${{ steps.budget_check.outputs.budget_utilization }}"
          echo "üíµ Budget remaining: ${{ steps.budget_check.outputs.budget_remaining }}"

          # Run with cost tracking
          poetry run python main.py
          echo "‚úÖ Tournament forecasting completed successfully"
        env:
          # Required API keys (must be configured in GitHub secrets)
          METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

          # Optional API keys (will use fallback if not configured)
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY || 'dummy_perplexity_key' }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY || 'dummy_exa_key' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'dummy_openai_key' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || 'dummy_anthropic_key' }}
          ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID || 'dummy_asknews_client' }}
          ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET || 'dummy_asknews_secret' }}

          # Bot configuration
          APP_ENV: production
          LOG_LEVEL: INFO
          DRY_RUN: false

          # Tournament configuration
          PUBLISH_REPORTS: true
          AIB_TOURNAMENT_ID: 32813
          TOURNAMENT_MODE: true

          # Budget management configuration
          BUDGET_LIMIT: ${{ vars.BUDGET_LIMIT || '100' }}
          COST_TRACKING_ENABLED: true
          EMERGENCY_MODE_THRESHOLD: 0.95
          CONSERVATIVE_MODE_THRESHOLD: 0.80
          BUDGET_STATUS: ${{ steps.budget_check.outputs.budget_status }}

          # Tournament scheduling configuration
          SCHEDULING_FREQUENCY_HOURS: ${{ github.event.inputs.scheduling_frequency_hours || vars.SCHEDULING_FREQUENCY_HOURS || '4' }}
          DEADLINE_AWARE_SCHEDULING: ${{ vars.DEADLINE_AWARE_SCHEDULING || 'true' }}
          CRITICAL_PERIOD_FREQUENCY_HOURS: ${{ vars.CRITICAL_PERIOD_FREQUENCY_HOURS || '2' }}
          FINAL_24H_FREQUENCY_HOURS: ${{ vars.FINAL_24H_FREQUENCY_HOURS || '1' }}
          TOURNAMENT_SCOPE: ${{ vars.TOURNAMENT_SCOPE || 'seasonal' }}
          TOURNAMENT_MODE_INPUT: ${{ github.event.inputs.tournament_mode || 'normal' }}

          # Metaculus proxy configuration
          ENABLE_PROXY_CREDITS: true
          METACULUS_DEFAULT_MODEL: ${{ secrets.METACULUS_DEFAULT_MODEL || 'metaculus/claude-3-5-sonnet' }}
          METACULUS_SUMMARIZER_MODEL: ${{ secrets.METACULUS_SUMMARIZER_MODEL || 'metaculus/gpt-4o-mini' }}
          METACULUS_RESEARCH_MODEL: ${{ secrets.METACULUS_RESEARCH_MODEL || 'metaculus/gpt-4o' }}
          MAX_PROXY_REQUESTS: 1000

      - name: Generate cost report
        if: always() && steps.budget_check.outputs.budget_utilization >= '0.0'
        run: |
          echo "üìä Generating post-run cost report..."
          poetry run python -c "
          from src.infrastructure.config.budget_manager import BudgetManager
          from src.infrastructure.monitoring.budget_dashboard import BudgetDashboard
          import os
          import json
          from datetime import datetime

          budget_manager = BudgetManager(budget_limit=float(os.getenv('BUDGET_LIMIT', '100')))
          dashboard = BudgetDashboard(budget_manager)

          # Generate comprehensive report
          status = budget_manager.get_budget_status()
          report = {
              'timestamp': datetime.now().isoformat(),
              'workflow_run': os.getenv('GITHUB_RUN_NUMBER'),
              'budget_status': status,
              'recommendations': dashboard.get_budget_recommendations()
          }

          print('üìä Cost Report Summary:')
          print(f'  üí∞ Total Budget: \${status[\"budget_limit\"]:.2f}')
          print(f'  üí∏ Amount Spent: \${status[\"spent\"]:.2f}')
          print(f'  üíµ Remaining: \${status[\"remaining\"]:.2f}')
          print(f'  üìà Utilization: {status[\"utilization\"]:.1%}')
          print(f'  üéØ Status: {status[\"status\"]}')

          # Save detailed report
          with open('cost_report.json', 'w') as f:
              json.dump(report, f, indent=2)

          print('üìÑ Detailed cost report saved to cost_report.json')
          "
        env:
          BUDGET_LIMIT: ${{ vars.BUDGET_LIMIT || '100' }}

      - name: Check for budget alerts
        if: always() && steps.budget_check.outputs.budget_utilization >= '0.80'
        run: |
          echo "üö® Budget Alert Triggered!"
          echo "Current utilization: ${{ steps.budget_check.outputs.budget_utilization }}"
          echo "Remaining budget: ${{ steps.budget_check.outputs.budget_remaining }}"

          if (( $(echo "${{ steps.budget_check.outputs.budget_utilization }} >= 0.95" | bc -l) )); then
            echo "üî¥ CRITICAL ALERT: Budget utilization >= 95%"
            echo "Action required: Consider suspending automated runs"
          elif (( $(echo "${{ steps.budget_check.outputs.budget_utilization }} >= 0.80" | bc -l) )); then
            echo "üü° WARNING ALERT: Budget utilization >= 80%"
            echo "Action recommended: Monitor closely and consider conservative mode"
          fi

      - name: Monitor deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Tournament forecasting deployment successful"
            echo "üìä Monitoring: Bot executed without errors"
            echo "üí∞ Budget Status: ${{ steps.budget_check.outputs.budget_status }}"
            echo "üìà Budget Utilization: ${{ steps.budget_check.outputs.budget_utilization }}"
          else
            echo "‚ùå Tournament forecasting deployment failed"
            echo "üîç Check logs above for error details"

            # Check if failure was due to budget exhaustion
            if [ "${{ steps.budget_check.outputs.budget_utilization }}" != "" ]; then
              if (( $(echo "${{ steps.budget_check.outputs.budget_utilization }} >= 0.98" | bc -l) )); then
                echo "üí∏ Failure cause: Budget exhausted"
                echo "üõë Workflow suspended due to budget limits"
              fi
            fi
            exit 1
          fi

      - name: Upload cost report and logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tournament-run-${{ github.run_number }}-${{ steps.budget_check.outputs.budget_status || 'unknown' }}
          path: |
            cost_report.json
            *.log
            logs/
          retention-days: 30

      - name: Budget exhaustion workflow suspension
        if: always() && steps.budget_check.outputs.budget_utilization >= '0.98'
        run: |
          echo "üö® CRITICAL: Budget exhausted, workflow should be suspended"
          echo "Current utilization: ${{ steps.budget_check.outputs.budget_utilization }}"
          echo "Remaining budget: ${{ steps.budget_check.outputs.budget_remaining }}"
          echo ""
          echo "üõë RECOMMENDED ACTIONS:"
          echo "1. Disable scheduled workflow runs"
          echo "2. Review cost optimization opportunities"
          echo "3. Consider increasing budget if tournament continues"
          echo "4. Switch to manual forecasting mode if needed"

          # This will cause the workflow to fail, preventing future scheduled runs
          # until the issue is addressed
          exit 1
