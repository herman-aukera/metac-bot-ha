name: Test Forecasting Tools Dependency

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/run_bot_on_*.yaml'

jobs:
  test-forecasting-tools:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”§ Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ“¦ Test dependency installation
        run: |
          echo "ğŸ” Testing Poetry installation..."
          if poetry install --only main; then
            echo "âœ… Poetry installation successful"
            POETRY_SUCCESS=true
          else
            echo "âš ï¸ Poetry failed, testing pip fallback..."
            POETRY_SUCCESS=false
          fi

          if [ "$POETRY_SUCCESS" = "false" ]; then
            echo "ğŸ”„ Testing emergency pip installation..."
            pip install --upgrade pip
            pip install python-dotenv pydantic requests openai anthropic PyYAML forecasting-tools httpx aiofiles
          fi

      - name: ğŸ§ª Test critical imports
        run: |
          echo "ğŸ§ª Testing all critical imports:"
          python -c "
          import sys
          packages = ['dotenv', 'pydantic', 'requests', 'openai', 'forecasting_tools']
          all_success = True
          for pkg in packages:
              try:
                  __import__(pkg)
                  print(f'âœ… {pkg}: imported successfully')
              except ImportError as e:
                  print(f'âŒ {pkg}: {e}')
                  all_success = False

          if all_success:
              print('ğŸ‰ All critical dependencies are available!')
              sys.exit(0)
          else:
              print('ğŸ’¥ Some dependencies failed to import')
              sys.exit(1)
          "

      - name: ğŸ§ª Test main.py imports
        run: |
          echo "ğŸ§ª Testing main.py import resolution:"
          python -c "
          try:
              from dotenv import load_dotenv
              print('âœ… dotenv import from main.py works')

              # Test the actual imports from main.py
              from forecasting_tools import (
                  AskNewsSearcher,
                  BinaryQuestion,
                  ForecastBot,
                  GeneralLlm,
                  MetaculusApi,
                  MetaculusQuestion,
                  MultipleChoiceQuestion,
                  NumericDistribution,
                  NumericQuestion,
                  PredictedOption
              )
              print('âœ… All forecasting_tools imports from main.py work!')
              print('ğŸ‰ main.py should be able to start successfully!')

          except ImportError as e:
              print(f'âŒ main.py import failed: {e}')

              # Fallback: explore what's actually available
              try:
                  import forecasting_tools
                  print(f'ğŸ“¦ forecasting_tools available attributes: {[attr for attr in dir(forecasting_tools) if not attr.startswith(\"_\")]}')
              except ImportError:
                  print('âŒ forecasting_tools package not available at all')

              import sys
              sys.exit(1)
          "
