name: Test Forecasting Tools Dependency

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/run_bot_on_*.yaml'

jobs:
  test-forecasting-tools:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”§ Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ“¦ Test dependency installation
        run: |
          echo "ğŸ” Testing Poetry installation..."
          # Try Poetry first but immediately fall back to pip if ANY issues
          if poetry install --only main 2>/dev/null && poetry run python --version >/dev/null 2>&1; then
            echo "âœ… Poetry installation successful"
            POETRY_SUCCESS=true
          else
            echo "âš ï¸ Poetry installation failed or environment broken, falling back to pip immediately..."
            POETRY_SUCCESS=false
          fi

          # Immediate pip fallback with essential packages
          if [ "$POETRY_SUCCESS" = "false" ]; then
            echo "ğŸ”„ Installing essential packages via pip..."
            python3 -m pip install --upgrade pip

            # Install critical packages that are needed for forecasting tools
            python3 -m pip install python-dotenv pydantic requests openai anthropic httpx aiofiles pyyaml typer pytest

            # Install forecasting_tools (critical for this test workflow)
            python3 -m pip install forecasting-tools || echo "âš ï¸ forecasting-tools not available via pip"

            # Try installing as editable package if possible
            python3 -m pip install -e . 2>/dev/null || echo "âš ï¸ Local package install failed"
          fi

          # Configure portable Python runner for subsequent steps
      if poetry env info >/dev/null 2>&1 && poetry run python --version >/dev/null 2>&1; then
            echo "PY_RUN=poetry run python" >> "$GITHUB_ENV"
            echo "âœ… Using Poetry environment for tests"
          else
      echo "PY_RUN=python3" >> "$GITHUB_ENV"
            echo "PYTHONPATH=$GITHUB_WORKSPACE/src" >> "$GITHUB_ENV"
            echo "âš ï¸ Using system Python with PYTHONPATH for tests"
          fi

    - name: ğŸ§ª Test critical imports
    run: |
      echo "ğŸ§ª Testing all critical imports:"
      $PY_RUN -c "
      import sys
      packages = ['dotenv', 'pydantic', 'requests', 'openai', 'forecasting_tools']
      all_success = True
      for pkg in packages:
        try:
          __import__(pkg)
          print(f'âœ… {pkg}: imported successfully')
        except ImportError as e:
          print(f'âŒ {pkg}: {e}')
          all_success = False

      if all_success:
        print('ğŸ‰ All critical dependencies are available!')
        sys.exit(0)
      else:
        print('ğŸ’¥ Some dependencies failed to import')
        sys.exit(1)
      "

    - name: ğŸ§ª Test main.py imports
    run: |
      echo "ğŸ§ª Testing main.py import resolution:"
      $PY_RUN -c "
      try:
        from dotenv import load_dotenv
        print('âœ… dotenv import from main.py works')

        # Test the actual imports from main.py
        from forecasting_tools import (
          AskNewsSearcher,
          BinaryQuestion,
          ForecastBot,
          GeneralLlm,
          MetaculusApi,
          MetaculusQuestion,
          MultipleChoiceQuestion,
          NumericDistribution,
          NumericQuestion,
          PredictedOption
        )
        print('âœ… All forecasting_tools imports from main.py work!')
        print('ğŸ‰ main.py should be able to start successfully!')

      except ImportError as e:
        print(f'âŒ main.py import failed: {e}')

        # Fallback: explore what's actually available
        try:
          import forecasting_tools
          print(f'ğŸ“¦ forecasting_tools available attributes: {[attr for attr in dir(forecasting_tools) if not attr.startswith(\"_\")]})')
        except ImportError:
          print('âŒ forecasting_tools package not available at all')

        import sys
        sys.exit(1)
      "
