name: Tournament Ready CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  kickoff:
    name: Kickoff
    runs-on: ubuntu-latest
    steps:
      - name: No-op kickoff
        run: echo "Kickoff job running to ensure workflow is not empty"

  tournament-readiness:
    name: Tournament Readiness Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Install dependencies
        run: |
          poetry check || true
          if ! poetry install --no-interaction --no-root; then
            echo "Poetry install failed, trying pip fallback for minimal deps"
            python -m pip install --upgrade pip --timeout 60 --retries 3
            if [ -f requirements-emergency.txt ]; then
              python -m pip install --timeout 60 --retries 3 -r requirements-emergency.txt || true
            fi
            python -m pip install --timeout 60 --retries 3 requests openai pydantic typer python-dotenv httpx || true
            echo "PYTHONPATH=$GITHUB_WORKSPACE/src" >> "$GITHUB_ENV"
          fi
          if poetry env info >/dev/null 2>&1; then
            echo "PY_RUN=poetry run python" >> "$GITHUB_ENV"
          else
            echo "PY_RUN=python" >> "$GITHUB_ENV"
          fi

      - name: Run tournament readiness check (non-fatal)
        run: |
          echo "ðŸ† Checking tournament readiness..."
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.fork }}" = "true" ]; then
            echo "âš ï¸  Running from fork - secrets not available, using mock deployment check"
            $PY_RUN scripts/ci_deployment_check.py --fork-mode || echo "Fork deployment check completed"
          else
            echo "ðŸ” Running with full secrets access"
            if ! $PY_RUN scripts/ci_deployment_check.py; then
              echo "âš ï¸ Readiness check failed but will not fail the job (recording results)"
              echo "READINESS_FAILED=true" >> "$GITHUB_ENV"
            fi
          fi
        env:
          CI: true
          ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID }}
          ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}

      - name: Validate budget router (best effort)
        run: |
          echo "ðŸ’° Testing budget-aware model router..."
          $PY_RUN - <<'PY'
          from src.infrastructure.model_router import BudgetAwareModelRouter
          router = BudgetAwareModelRouter()
          print('âœ… Budget router working')
          print('CI Model:', router.select_model('test', True, True))
          PY
        env:
          CI: true
          ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID }}
          ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
