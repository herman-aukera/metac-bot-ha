name: Tournament Ready CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  tournament-readiness:
    name: Tournament Readiness Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Install dependencies
        run: |
          poetry check || true
          poetry install --no-interaction --no-root || (
            echo "Poetry install failed, trying pip fallback for minimal deps" && \
            python -m pip install --upgrade pip && \
            python -m pip install pydantic requests python-dotenv pyyaml || true
          )

      - name: Run tournament readiness check
        run: |
          echo "üèÜ Checking tournament readiness..."
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.fork }}" = "true" ]; then
            echo "‚ö†Ô∏è  Running from fork - secrets not available, using mock deployment check"
            poetry run python scripts/ci_deployment_check.py --fork-mode || echo "Fork deployment check completed"
          else
            echo "üîê Running with full secrets access"
            poetry run python scripts/ci_deployment_check.py
          fi
        env:
          CI: true
          ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID }}
          ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}

      - name: Validate budget router
        run: |
          echo "üí∞ Testing budget-aware model router..."
          poetry run python -c "
          from src.infrastructure.model_router import BudgetAwareModelRouter
          router = BudgetAwareModelRouter()
          print('‚úÖ Budget router working')
          print('CI Model:', router.select_model('test', True, True))
          "
        env:
          CI: true
          ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID }}
          ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
