name: Workflow Management and Auto-Suspension

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - suspend_all
          - resume_all
          - check_status
        default: 'check_status'
      reason:
        description: 'Reason for action'
        required: false
        default: 'Manual intervention'
        type: string
      budget_status:
        description: 'Budget status string when calling manually'
        required: false
        default: 'unknown'
        type: string
      utilization:
        description: 'Utilization value when calling manually'
        required: false
        default: '0'
        type: string

  # Trigger from budget monitoring workflow
  workflow_call:
    inputs:
      action:
        required: true
        type: string
      budget_status:
        required: true
        type: string
      remaining_budget:
        required: false
        type: string
      utilization:
        required: true
        type: string

permissions:
  contents: write
  actions: write

concurrency:
  group: workflow-management
  cancel-in-progress: false

jobs:
  workflow_management:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine action
        id: determine_action
        run: |
          ACTION="${{ github.event.inputs.action || inputs.action }}"
          BUDGET_STATUS="${{ github.event.inputs.budget_status || inputs.budget_status || 'unknown' }}"
          UTILIZATION="${{ github.event.inputs.utilization || inputs.utilization || '0' }}"
          REASON="${{ github.event.inputs.reason || 'Automated budget management' }}"

          {
            echo "action=$ACTION"
            echo "budget_status=$BUDGET_STATUS"
            echo "utilization=$UTILIZATION"
            echo "reason=$REASON"
          } >> "$GITHUB_OUTPUT"

          echo "ğŸ”§ Workflow Management Action: $ACTION"
          echo "ğŸ’° Budget Status: $BUDGET_STATUS"
          echo "ğŸ“Š Utilization: $UTILIZATION"
          echo "ğŸ“ Reason: $REASON"

      - name: Check current workflow status
        id: check_workflows
        run: |
          echo "ğŸ” Checking current workflow status..."

          # List of workflows to manage
          WORKFLOWS=(
            "run_bot_on_tournament.yaml"
            "tournament_deadline_aware.yaml"
            "run_bot_on_quarterly_cup.yaml"
          )

          echo "ğŸ“‹ Managed Workflows:"
          for workflow in "${WORKFLOWS[@]}"; do
            if [ -f ".github/workflows/$workflow" ]; then
              # Check if workflow has active cron schedules
              if grep -q "cron:" ".github/workflows/$workflow" && ! grep -q "#.*cron:" ".github/workflows/$workflow"; then
                echo "  âœ… $workflow - ACTIVE"
                echo "active_workflows=$workflow" >> "$GITHUB_OUTPUT"
              else
                echo "  â¸ï¸ $workflow - SUSPENDED"
              fi
            else
              echo "  â“ $workflow - NOT FOUND"
            fi
          done

      - name: Suspend workflows
        if: steps.determine_action.outputs.action == 'suspend_all'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ›‘ Suspending tournament workflows via GitHub API..."
          echo "ğŸ’° Budget Status: ${{ steps.determine_action.outputs.budget_status }}"
          echo "ğŸ“Š Utilization: ${{ steps.determine_action.outputs.utilization }}"
          echo "ğŸ“ Reason: ${{ steps.determine_action.outputs.reason }}"

          WORKFLOWS=(
            "run_bot_on_tournament.yaml"
            "tournament_deadline_aware.yaml"
            "run_bot_on_quarterly_cup.yaml"
          )

          for workflow in "${WORKFLOWS[@]}"; do
            echo "ï¿½ Disabling $workflow..."
            curl -s -X PUT \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/${workflow}/disable" \
              | jq -r '.state? // "ok"' || true
          done

          echo "ğŸ›‘ All managed workflows have been disabled"

      - name: Resume workflows
        if: steps.determine_action.outputs.action == 'resume_all'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â–¶ï¸ Enabling tournament workflows via GitHub API..."
          echo "ğŸ“ Reason: ${{ steps.determine_action.outputs.reason }}"

          WORKFLOWS=(
            "run_bot_on_tournament.yaml"
            "tournament_deadline_aware.yaml"
            "run_bot_on_quarterly_cup.yaml"
          )

          for workflow in "${WORKFLOWS[@]}"; do
            echo "ï¿½ Enabling $workflow..."
            curl -s -X PUT \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/${workflow}/enable" \
              | jq -r '.state? // "ok"' || true
          done

          echo "â–¶ï¸ All managed workflows have been enabled"

      - name: Generate status report
        if: steps.determine_action.outputs.action == 'check_status'
        run: |
          echo "ğŸ“Š WORKFLOW STATUS REPORT"
          echo "=" * 50
          echo "ğŸ• Check Time: $(date -u)"
          echo "ğŸ’° Budget Status: ${{ steps.determine_action.outputs.budget_status }}"
          echo "ğŸ“Š Utilization: ${{ steps.determine_action.outputs.utilization }}"
          echo ""

          WORKFLOWS=(
            "run_bot_on_tournament.yaml"
            "tournament_deadline_aware.yaml"
            "run_bot_on_quarterly_cup.yaml"
          )

          echo "ğŸ“‹ Workflow Status:"
          for workflow in "${WORKFLOWS[@]}"; do
            if [ -f ".github/workflows/$workflow" ]; then
              if grep -q "WORKFLOW SUSPENDED" ".github/workflows/$workflow"; then
                echo "  ğŸ›‘ $workflow - SUSPENDED"
              elif grep -q "cron:" ".github/workflows/$workflow" && ! grep -q "#.*cron:" ".github/workflows/$workflow"; then
                echo "  âœ… $workflow - ACTIVE"
              else
                echo "  â¸ï¸ $workflow - INACTIVE (no cron schedule)"
              fi
            else
              echo "  â“ $workflow - NOT FOUND"
            fi
          done

          echo ""
          echo "ğŸ”§ Available Actions:"
          echo "  â€¢ suspend_all - Suspend all tournament workflows"
          echo "  â€¢ resume_all - Resume all tournament workflows"
          echo "  â€¢ check_status - Show current status (this report)"

      - name: Note
        if: steps.determine_action.outputs.action != 'check_status'
        run: |
          echo "â„¹ï¸ Workflows were enabled/disabled via API; no file changes were committed."

      - name: Action summary
        if: always()
        run: |
          echo "ğŸ“‹ WORKFLOW MANAGEMENT SUMMARY"
          echo "=" * 50
          echo "ğŸ”§ Action Performed: ${{ steps.determine_action.outputs.action }}"
          echo "ğŸ’° Budget Status: ${{ steps.determine_action.outputs.budget_status }}"
          echo "ğŸ“Š Utilization: ${{ steps.determine_action.outputs.utilization }}"
          echo "ğŸ“ Reason: ${{ steps.determine_action.outputs.reason }}"
          echo "ğŸ• Completed: $(date -u)"
          echo ""

          case "${{ steps.determine_action.outputs.action }}" in
            "suspend_all")
              echo "ğŸ›‘ All tournament workflows have been suspended"
              echo "ğŸ’¾ Backups created in .github/workflow_backups/"
              echo "â–¶ï¸ To resume: Run this workflow with action 'resume_all'"
              ;;
            "resume_all")
              echo "â–¶ï¸ All tournament workflows have been resumed"
              echo "ğŸ” Verify workflows are active in the Actions tab"
              ;;
            "check_status")
              echo "ğŸ“Š Status report generated above"
              echo "ğŸ”§ Use suspend_all or resume_all actions as needed"
              ;;
          esac
